{% extends "base.html" %}
{% block content %}
<section class="hero hero-row">
  <div>
    <p class="hero-kicker">Operations</p>
    <h2 class="hero-title">안내사항 / 인수인계</h2>
    <p class="hero-desc">{{ staff.name }} · 최신 공지와 인수인계 내역을 함께 관리합니다.</p>
  </div>
  <a class="btn btn-secondary" href="/staff/logout">로그아웃</a>
</section>
{% include "staff_menu.html" %}

<section class="card">
  <h3 class="card-title">{% if editing_note %}게시글 편집{% else %}글 등록{% endif %}</h3>
  <form action="{% if editing_note %}/staff/handover/{{ editing_note.note_id }}/update{% else %}/staff/handover{% endif %}" method="post" class="grid2">
    <label class="field">
      <span class="field-label">구분</span>
      <select class="control" name="category">
        {% for category in NOTE_CATEGORIES %}
        <option value="{{ category }}" {% if editing_note and editing_note.category == category %}selected{% endif %}>{{ display_note_category(category) }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="field">
      <span class="field-label">제목</span>
      <input class="control" type="text" name="title" value="{{ editing_note.title if editing_note else '' }}" placeholder="예: 금일 재고 점검 안내" required />
    </label>

    <label class="field" style="grid-column: 1 / -1;">
      <span class="field-label">내용</span>
      <textarea class="control" name="content" rows="4" placeholder="업무 공유 내용을 입력하세요." required>{{ editing_note.content if editing_note else '' }}</textarea>
    </label>

    <label class="pin-chip">
      <input type="checkbox" name="is_pinned" {% if editing_note and editing_note.is_pinned %}checked{% endif %} />
      <span>상단 고정</span>
    </label>

    <label class="button-wrap">
      <span class="field-label sr-only">{% if editing_note %}수정 저장{% else %}등록{% endif %}</span>
      <button class="btn btn-primary" type="submit">{% if editing_note %}수정 저장{% else %}등록{% endif %}</button>
    </label>
    {% if editing_note %}
    <a class="btn btn-secondary" href="/staff/handover">편집 취소</a>
    {% endif %}
  </form>
</section>

<section class="card">
  <h3 class="card-title">게시 목록</h3>
  <form action="/staff/handover" method="get" class="staff-search-form handover-search-form">
    <input type="hidden" name="unread_only" value="{% if unread_only %}1{% else %}0{% endif %}" />
    <div class="status-filter-buttons handover-filter-buttons">
      <a class="status-filter-all {% if not unread_only %}is-active{% endif %}" href="/staff/handover{% if q %}?q={{ q | urlencode }}{% endif %}">전체</a>
      <a class="status-filter-all {% if unread_only %}is-active{% endif %}" href="/staff/handover?unread_only=1{% if q %}&q={{ q | urlencode }}{% endif %}">안읽은 글</a>
    </div>
    <div class="staff-search-row">
      <label class="field">
        <span class="field-label">게시글 검색 (실시간)</span>
        <input class="control js-handover-search-input" type="text" name="q" value="{{ q }}" placeholder="제목, 내용, 작성자, 댓글 검색" autocomplete="off" />
      </label>
      <label class="button-wrap staff-search-button-wrap">
        <span class="field-label sr-only">검색</span>
        <button class="btn btn-primary" type="submit">검색</button>
      </label>
    </div>
    {% if q or unread_only %}
    <div class="inline-actions">
      <a class="btn btn-secondary btn-sm" href="/staff/handover">검색 초기화</a>
      {% if q %}<span class="muted">"{{ q }}" 검색 결과</span>{% endif %}
      {% if unread_only %}<span class="muted">안읽은 게시물만 표시 중</span>{% endif %}
    </div>
    {% endif %}
  </form>

  <div class="ops-board" id="handover-board" data-unread-only="{{ '1' if unread_only else '0' }}">
    {% for note in notes %}
    <article
      class="ops-item js-note-item {% if note.note_id not in current_staff_read_note_ids %}ops-item-unread{% endif %}"
      data-note-id="{{ note.note_id }}"
      data-is-read="{% if note.note_id in current_staff_read_note_ids %}1{% else %}0{% endif %}"
      data-note-search="{{ note_search_text_by_note.get(note.note_id, '') | e }}"
    >
      <div class="ops-item-head">
        <div class="ops-badges">
          <span class="status-pill status-paid">{{ display_note_category(note.category) }}</span>
          {% if note.is_pinned %}
          <span class="status-pill status-picked_up">고정</span>
          {% endif %}
        </div>
        <div class="ops-item-head-right">
          <span class="muted">{{ to_jst_datetime(note.created_at).strftime('%Y-%m-%d %H:%M') }}</span>
          <form action="/staff/handover/{{ note.note_id }}/read" method="post" class="js-read-toggle-form" data-note-id="{{ note.note_id }}">
            <input type="hidden" name="is_read" value="{% if note.note_id in current_staff_read_note_ids %}1{% else %}0{% endif %}" />
            {% if q %}
            <input type="hidden" name="q" value="{{ q }}" />
            {% endif %}
            {% if unread_only %}
            <input type="hidden" name="unread_only" value="1" />
            {% endif %}
            <label class="read-chip">
              <input class="js-note-read" type="checkbox" {% if note.note_id in current_staff_read_note_ids %}checked{% endif %} />
              <span>읽음</span>
            </label>
          </form>
        </div>
      </div>
      <h4 class="ops-item-title">{{ note.title }}</h4>
      <p class="ops-item-body">{{ note.content }}</p>
      <p class="card-desc">작성자: {{ author_name_by_note.get(note.note_id, '알 수 없음') }}</p>
      <p class="card-desc">읽은 직원: <span class="js-reader-names" data-note-id="{{ note.note_id }}">{{ ", ".join(reader_names_by_note.get(note.note_id, [])) if reader_names_by_note.get(note.note_id) else "-" }}</span></p>

      {% set note_comments = comments_by_note.get(note.note_id, []) %}
      <div class="handover-comments">
        <p class="card-desc">댓글 {{ note_comments|length }}</p>
        <div class="handover-comment-list">
          {% for comment in note_comments %}
          <div class="handover-comment-item">
            <div class="handover-comment-head">
              <p class="handover-comment-meta">
                {{ comment_author_name_by_id.get(comment.comment_id, '알 수 없음') }}
                · {{ to_jst_datetime(comment.created_at).strftime('%m-%d %H:%M') }}
              </p>
              {% if staff.is_admin or comment.staff_id == staff.staff_id %}
              <form
                action="/staff/handover/comments/{{ comment.comment_id }}/delete"
                method="post"
                class="handover-comment-delete-form"
                onsubmit="return confirm('이 댓글을 삭제하시겠습니까?');"
              >
                {% if q %}
                <input type="hidden" name="q" value="{{ q }}" />
                {% endif %}
                {% if unread_only %}
                <input type="hidden" name="unread_only" value="1" />
                {% endif %}
                <button class="btn btn-secondary btn-sm handover-comment-delete-btn" type="submit">삭제</button>
              </form>
              {% endif %}
            </div>
            <p class="handover-comment-body">{{ comment.content }}</p>
          </div>
          {% else %}
          <p class="muted handover-no-comments">댓글이 없습니다.</p>
          {% endfor %}
        </div>
        <form action="/staff/handover/{{ note.note_id }}/comments" method="post" class="handover-comment-form">
          {% if q %}
          <input type="hidden" name="q" value="{{ q }}" />
          {% endif %}
          {% if unread_only %}
          <input type="hidden" name="unread_only" value="1" />
          {% endif %}
          <input class="control handover-comment-input" type="text" name="content" maxlength="1000" placeholder="댓글 입력 후 Enter 또는 댓글 버튼" required />
          <button class="btn btn-secondary btn-sm" type="submit">댓글</button>
        </form>
      </div>

      <div class="inline-actions">
        <a class="btn btn-secondary btn-sm" href="/staff/handover?edit_id={{ note.note_id }}">편집</a>
        <form action="/staff/handover/{{ note.note_id }}/delete" method="post" onsubmit="return confirm('이 게시글을 삭제하시겠습니까?');">
          <button class="btn btn-secondary btn-sm" type="submit">삭제</button>
        </form>
      </div>
    </article>
    {% else %}
    <p class="muted">등록된 게시물이 없습니다.</p>
    {% endfor %}
    <p class="muted js-handover-empty" style="display: none;">검색 결과가 없습니다.</p>
  </div>
</section>

<script src="/static/staff_handover.js?v=20260302a"></script>
{% endblock %}
