{% extends "base.html" %}
{% block content %}
{% set status_label = {'PAYMENT_PENDING': '결제대기', 'PAID': '결제완료', 'PICKED_UP': '수령완료'} %}
{% set payment_label = {'PAY_QR': 'QR결제', 'CASH': '현금'} %}
<section class="hero hero-row">
  <div>
    <p class="hero-kicker">접수 상세</p>
    <h2 class="hero-title">접수 상세: {{ order.order_id }}</h2>
    <p class="hero-desc">수정 가능한 필드만 조정 가능합니다.</p>
  </div>
  <a class="btn btn-secondary" href="/staff/dashboard">목록으로</a>
</section>
{% include "staff_menu.html" %}

<section class="card">
  <h3 class="card-title">직원 수정 (허용 항목)</h3>
  <p class="card-desc">이름/전화번호/짐번호/예정 픽업일시/비고만 수정됩니다. 결제 및 수령 상태 처리는 아래에서 진행하세요.</p>
  <form action="/staff/orders/{{ order.order_id }}/update" method="post" class="grid2">
    <label class="field">
      <span class="field-label">이름</span>
      <input class="control" type="text" name="name" value="{{ order.name }}" required />
    </label>

    <label class="field">
      <span class="field-label">전화번호</span>
      <input class="control" type="text" name="phone" value="{{ order.phone }}" required />
    </label>

    <label class="field">
      <span class="field-label">짐번호</span>
      <input class="control" type="text" name="tag_no" value="{{ order.tag_no if order.tag_no else '' }}" />
    </label>

    <label class="field">
      <span class="field-label">예정 픽업일/시간</span>
      <input class="control" type="datetime-local" name="expected_pickup_at" value="{{ expected_pickup_jst.strftime('%Y-%m-%dT%H:%M') }}" required />
    </label>

    <label class="field">
      <span class="field-label">비고</span>
      <textarea class="control" name="note" rows="3" placeholder="메모를 입력하세요.">{{ order.note if order.note else '' }}</textarea>
    </label>

    <label class="button-wrap">
      <span class="field-label sr-only">저장</span>
      <button class="btn btn-primary" type="submit">저장</button>
    </label>
  </form>
</section>

<section class="grid2">
  <section class="card">
    <h3 class="card-title">신분증 사진</h3>
    {% if order.id_image_url %}
    <img class="thumb" src="/staff/orders/{{ order.order_id }}/id-image" alt="신분증 사진" />
    {% else %}
    <p class="muted">이미지 없음</p>
    {% endif %}
  </section>

  <section class="card">
    <h3 class="card-title">짐 사진</h3>
    {% if order.luggage_image_url %}
    <img class="thumb" src="/staff/orders/{{ order.order_id }}/luggage-image" alt="짐 사진" />
    {% else %}
    <p class="muted">이미지 없음</p>
    {% endif %}
  </section>
</section>

<section class="card">
  <h3 class="card-title">요약</h3>
  <div class="summary-grid">
    <p><strong>상태</strong><span class="status-pill status-{{ order.status|lower }}">{{ status_label.get(order.status, '미정') }}</span></p>
    <p><strong>수기접수 여부</strong><span>{{ '예' if order.manual_entry else '아니오' }}</span></p>
    <p><strong>생성</strong><span>{{ created_jst.strftime('%Y-%m-%d %H:%M JST') }}</span></p>
    <p><strong>최종 수정시각</strong><span>{{ updated_jst.strftime('%Y-%m-%d %H:%M JST') }}</span></p>
    <p><strong>최종 수정자</strong><span>{{ last_modified_staff.name if last_modified_staff else '-' }}</span></p>
    <p><strong>예정 픽업</strong><span>{{ expected_pickup_jst.strftime('%Y-%m-%d %H:%M JST') }}</span></p>
    <p><strong>실제 픽업</strong><span>{{ actual_pickup_jst.strftime('%Y-%m-%d %H:%M JST') if actual_pickup_jst else '-' }}</span></p>
    <p><strong>짐번호</strong><span>{{ order.tag_no if order.tag_no else '-' }}</span></p>
    <p><strong>결제수단</strong><span>{{ payment_label.get(order.payment_method, '-') if order.payment_method else '-' }}</span></p>
    <p><strong>동행인원</strong><span>{{ order.companion_count }}</span></p>
    <p><strong>비고</strong><span>{{ order.note if order.note else '-' }}</span></p>
    <p><strong>짐</strong><span>캐리어 {{ order.suitcase_qty }}, 백팩 {{ order.backpack_qty }}, 세트 {{ order.set_qty }}</span></p>
    <p><strong>요금</strong><span>일 {{ order.price_per_day | yen }}, 선결제 {{ order.prepaid_amount | yen }}, 추가 {{ order.extra_amount | yen }}, 최종 {{ order.final_amount | yen }}</span></p>
    <p><strong>멤버할인</strong><span>{{ display_flying_pass_tier(order.flying_pass_tier) }} / 할인 {{ order.flying_pass_discount_amount | yen }} / 직원수정 {{ order.staff_prepaid_override_amount | yen if order.staff_prepaid_override_amount is not none else '없음' }}</span></p>
    <p><strong>일수</strong><span>예정 {{ order.expected_storage_days }}, 실제 {{ order.actual_storage_days if order.actual_storage_days else '-' }}, 초과 {{ order.extra_days }}</span></p>
  </div>
</section>

<section class="card">
  <h3 class="card-title">업무 처리</h3>
  <div class="detail-action-grid">
    <section class="detail-action-box">
      <h4 class="detail-action-title">결제 처리</h4>
      {% if order.status == 'PAYMENT_PENDING' %}
      <p class="card-desc">짐번호는 접수 순서대로 자동 부여됩니다.</p>
      <form action="/staff/orders/{{ order.order_id }}/mark-paid" method="post" class="detail-action-form">
        <label class="field">
          <span class="field-label">결제수단</span>
          <select class="control" name="payment_method">
            <option value="PAY_QR" {% if order.payment_method == 'PAY_QR' %}selected{% endif %}>QR결제</option>
            <option value="CASH" {% if order.payment_method == 'CASH' %}selected{% endif %}>현금</option>
          </select>
        </label>
        <button class="btn btn-primary" type="submit">결제 완료</button>
      </form>
      {% else %}
      <p class="card-desc">현재 결제 상태는 결제완료입니다.</p>
      <span class="status-pill status-paid">결제완료</span>
      {% endif %}
    </section>

    <section class="detail-action-box">
      <h4 class="detail-action-title">수령 처리</h4>
      <p class="card-desc">초과일은 할인 없이 정가 후불 계산됩니다.</p>
      {% if order.status != 'PICKED_UP' %}
      <form action="/staff/orders/{{ order.order_id }}/mark-picked-up" method="post" class="detail-action-form">
        <button class="btn btn-primary" type="submit">수령 완료</button>
      </form>
      {% else %}
      <p class="card-desc">수령 완료 시각: {{ actual_pickup_jst.strftime('%Y-%m-%d %H:%M JST') if actual_pickup_jst else '-' }}</p>
      <form action="/staff/orders/{{ order.order_id }}/undo-picked-up" method="post" class="detail-action-form">
        <button class="btn btn-secondary" type="submit">수령 완료 취소</button>
      </form>
      {% endif %}
    </section>
  </div>
</section>
{% endblock %}
