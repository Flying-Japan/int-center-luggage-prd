{% extends "base.html" %}
{% block content %}
<section class="hero hero-row">
  <div>
    <p class="hero-kicker">Admin</p>
    <h2 class="hero-title">계정관리</h2>
    <p class="hero-desc">직원/매니저 계정을 생성하고 관리합니다.</p>
  </div>
</section>
{% include "staff_menu.html" %}

<section class="card">
  <h3 class="card-title">신규 계정 생성</h3>
  {% if msg %}
  <p class="success-note">{{ msg }}</p>
  {% endif %}
  {% if err %}
  <p class="error">{{ err }}</p>
  {% endif %}

  <form method="post" action="/staff/admin/staff-accounts" class="account-create-grid">
    <label class="field">
      <span class="field-label">이메일</span>
      <input class="control" type="email" name="email" maxlength="100" required />
    </label>
    <label class="field">
      <span class="field-label">임시 비밀번호</span>
      <input class="control" type="password" name="password" required />
    </label>
    <label class="field">
      <span class="field-label">권한</span>
      <select class="control" name="is_admin" required>
        <option value="0">직원</option>
        <option value="1">매니저(관리자)</option>
      </select>
    </label>
    <div class="button-wrap account-create-action">
      <button class="btn btn-primary" type="submit" onclick="return window.confirm('새 계정을 생성할까요?');">생성</button>
    </div>
  </form>
</section>

<section class="card">
  <div class="acct-header">
    <h3 class="card-title" style="margin:0">계정 목록</h3>
    <span class="acct-count">{{ staff_rows|length }}명 · 관리자 {{ active_admin_count }}명</span>
  </div>

  <table class="acct-tbl">
    <thead>
      <tr>
        <th class="acct-th" style="width:40%">이름</th>
        <th class="acct-th">권한</th>
        <th class="acct-th">상태</th>
        <th class="acct-th">로그인</th>
        <th class="acct-th acct-th--right"></th>
      </tr>
    </thead>
    <tbody>
      {% for row in staff_rows %}
      {% set is_open = (row.id == focus_staff_id) %}
      {% set initials = (row.display_name or row.username or '?')[:1]|upper %}
      <tr class="acct-tr {% if not row.is_active %}acct-tr--dim{% endif %}">
        <td class="acct-td">
          <div class="acct-cell-user">
            <span class="acct-ini {% if row.role == 'admin' %}acct-ini--admin{% elif row.role == 'editor' %}acct-ini--editor{% endif %}">{{ initials }}</span>
            <div>
              <span class="acct-uname">{{ row.display_name or row.username }}{% if row.id == staff.id %} <span class="acct-me">나</span>{% endif %}</span>
              <span class="acct-email">{{ row.username }}</span>
            </div>
          </div>
        </td>
        <td class="acct-td">
          <span class="acct-pill {% if row.role == 'admin' %}acct-pill--blue{% elif row.role == 'editor' %}acct-pill--teal{% else %}acct-pill--gray{% endif %}">
            {% if row.role == 'admin' %}관리자{% elif row.role == 'editor' %}직원{% else %}뷰어{% endif %}
          </span>
        </td>
        <td class="acct-td">
          <span class="acct-pill {% if row.is_active %}acct-pill--green{% else %}acct-pill--red{% endif %}">
            {{ "활성" if row.is_active else "잠금" }}
          </span>
        </td>
        <td class="acct-td">
          {% if row.id in google_user_ids %}<span class="acct-pill acct-pill--yellow">Google</span>{% else %}<span class="acct-pill acct-pill--gray">이메일</span>{% endif %}
        </td>
        <td class="acct-td acct-td--right">
          <button class="acct-link account-toggle-btn" type="button" data-target-id="acct-panel-{{ row.id }}" aria-expanded="{{ 'true' if is_open else 'false' }}">수정</button>
          <form method="post" action="/staff/admin/staff-accounts/{{ row.id }}/toggle-active" style="display:inline" onsubmit="return window.confirm('{{ '복구할까요?' if not row.is_active else '잠글까요?' }}');">
            <button class="acct-link {% if not row.is_active %}acct-link--green{% else %}acct-link--red{% endif %}" type="submit">{{ "복구" if not row.is_active else "잠금" }}</button>
          </form>
        </td>
      </tr>
      <tr class="acct-panel-row">
        <td colspan="5" style="padding:0;border:none">
          <div id="acct-panel-{{ row.id }}" class="acct-edit-panel {% if not is_open %}is-collapsed{% endif %}">
            <form method="post" action="/staff/admin/staff-accounts/{{ row.id }}/update" class="acct-edit-form" onsubmit="return window.confirm('저장할까요?');">
              <label class="field"><span class="field-label">표시 이름</span><input class="control" type="text" name="display_name" maxlength="100" value="{{ row.display_name or row.username }}" required /></label>
              <label class="field"><span class="field-label">권한</span>
                <select class="control" name="is_admin" required>
                  <option value="0" {% if row.role != 'admin' %}selected{% endif %}>직원</option>
                  <option value="1" {% if row.role == 'admin' %}selected{% endif %}>매니저</option>
                </select>
              </label>
              <label class="field"><span class="field-label">상태</span>
                <select class="control" name="is_active" required>
                  <option value="1" {% if row.is_active %}selected{% endif %}>활성</option>
                  <option value="0" {% if not row.is_active %}selected{% endif %}>비활성</option>
                </select>
              </label>
              <div class="button-wrap" style="margin:0"><button class="btn btn-secondary" type="submit">저장</button></div>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
(function () {
  document.querySelectorAll(".account-toggle-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      var id = btn.getAttribute("data-target-id");
      var panel = document.getElementById(id);
      if (!panel) return;
      var open = panel.classList.contains("is-collapsed");
      panel.classList.toggle("is-collapsed", !open);
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    });
  });
})();
</script>
{% endblock %}
