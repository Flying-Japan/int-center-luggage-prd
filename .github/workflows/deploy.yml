name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            REPO_DIR="/opt/int-center-luggage-prd"
            DEPLOY_DIR="$REPO_DIR/플라잉센터자동화"

            # First-time setup: clone if not present
            if [ ! -d "$REPO_DIR/.git" ]; then
              sudo mkdir -p "$REPO_DIR"
              sudo chown "$USER:$USER" "$REPO_DIR"
              git clone https://github.com/Flying-Japan/int-center-luggage-prd.git "$REPO_DIR"
            fi

            cd "$DEPLOY_DIR"
            git pull origin main

            # Write .env from secrets (overwrites on each deploy)
            printf '%s\n' \
              'APP_ENV=production' \
              'APP_SECRET_KEY=${{ secrets.APP_SECRET_KEY }}' \
              'SUPABASE_URL=${{ secrets.SUPABASE_URL }}' \
              'SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
              'UPLOAD_DIR=/app/uploads' \
              'SESSION_HTTPS_ONLY=true' \
              'AUTO_SEED_DEFAULT_STAFF=false' \
              'TUNNEL_TOKEN=${{ secrets.TUNNEL_TOKEN }}' \
              > .env

            docker compose up -d --build
            docker image prune -f
